# 📅 Calendar Tab 视图实现记录

**创建日期**: 2025-11-09  
**状态**: ✅ 第一阶段完成

---

## 📋 整体架构

### 四种视图模式

Calendar Tab 支持四种不同的视图模式，参考苹果日历系统设计：

| 视图模式 | 图标 | 状态 | 说明 |
|---------|-----|-----|------|
| **紧凑** | ✓ | ✅ 已实现 | 纵向滚动月历，点击展开24小时视图 |
| **叠放** | ≡ | 📦 预留 | 卡片堆叠效果（待实现） |
| **详细信息** | 昌 | 📦 预留 | 显示更多统计信息（待实现） |
| **列表** | ≣ | 📦 预留 | 时间线列表形式（待实现） |

### 视图切换

通过顶部导航栏右侧的**下拉菜单**（≡ 图标）切换视图模式：

```
┌─────────────────────┐
│ ✓ 紧凑              │ ← 当前已选中
│ ≡ 叠放              │ ← 预留，灰色显示
│ 昌 详细信息          │ ← 预留，灰色显示
│ ≣ 列表              │ ← 预留，灰色显示
└─────────────────────┘
```

---

## ✅ 第一阶段：紧凑视图（已完成）

### 1. 紧凑月视图（Collapsed State）

#### 功能特性

- ✅ **纵向滚动** - 可上下滑动浏览前后多个月份（前后各3个月）
- ✅ **月份标题** - 每个月份顶部显示大号红色月份标题
- ✅ **星期标题** - 每个月份显示星期标题行
- ✅ **日历网格** - 标准7x5或7x6网格布局
- ✅ **今日高亮** - 今天用红色圆圈标记
- ✅ **周末标识** - 周六日数字显示为浅灰色
- ✅ **事件标记** - 有事件的日期显示橙色圆点

#### 数据标记规则

```
🟠 橙色圆点（第1个）- 有打卡记录
🟠 橙色圆点（第2个）- 有番茄钟记录
```

#### 交互行为

- **点击日期** → 展开该日的详细视图（24小时时间轴）
- **纵向滚动** → 浏览不同月份
- **切换视图模式** → 通过顶部菜单切换

#### 视觉设计

```
┌─────────────────────────────────────┐
│  ← 2025年    [≡] [🔍] [+]          │ 顶部导航
├─────────────────────────────────────┤
│           11月                       │ 月份标题（红色）
│  一  二  三  四  五  六  日          │ 星期标题
│  3   4   5   6   7   8   9          │
│                  •       ⭕          │ •=事件 ⭕=今天
│  10  11  12  13  14  15  16         │
│  ...                                 │
├─────────────────────────────────────┤
│           12月                       │ 可滚动显示多月
│  一  二  三  四  五  六  日          │
│  1   2   3   4   5   6   7          │
└─────────────────────────────────────┘
```

---

### 2. 日详情视图（Expanded State）

#### 功能特性

- ✅ **迷你周视图** - 顶部显示一周日期，可左右滑动切换
- ✅ **日期标题** - 显示完整日期和星期
- ✅ **农历信息** - 显示农历日期（当前为占位）
- ✅ **全天事件区域** - 橙色背景区域显示打卡等全天事件
- ✅ **24小时时间轴** - 完整显示00:00-23:59
- ✅ **事件卡片** - 番茄钟记录显示在对应时间段
- ✅ **智能图标** - 根据时长显示不同图标（🍅/⚡/🔥）

#### 迷你周视图

```
┌─────────────────────────────────────┐
│  一  二  三  四  五  六  日          │
│  3   4   5   6  ⚫7  8   9          │ ⚫=选中 ⭕=今天
└─────────────────────────────────────┘
```

- **黑色圆圈** - 当前选中的日期
- **红色圆圈边框** - 今天（未选中时）
- **点击日期** - 切换查看不同日期的详情

#### 24小时时间轴

```
┌─────────────────────────────────────┐
│  2025年11月7日 - 周五               │ 日期标题
│  乙巳年九月十八                     │ 农历信息
├─────────────────────────────────────┤
│  全天  ⭐ 立冬                      │ 全天事件（橙色背景）
├─────────────────────────────────────┤
│  00:00 ─────────────────────        │
│  01:00 ─────────────────────        │
│  02:00 ─────────────────────        │
│  ...                                 │
│         ┌─────────────────┐         │
│  09:00 │ 🍅 专注工作      │         │ 番茄钟事件
│         │ 09:15 - 09:40   │         │
│         │ 25分钟          │         │
│  10:00 └─────────────────┘         │
│  ...                                 │
│  18:00 ─────────────────────        │
└─────────────────────────────────────┘
```

#### 事件卡片设计

**番茄钟事件卡片：**
- **背景色** - 红色半透明（AppColors.pomodoro.withOpacity(0.1)）
- **边框** - 红色（1.5px）
- **图标** - 🍅（<60分钟）/ ⚡（60-89分钟）/ 🔥（≥90分钟）
- **标题** - "专注工作"（红色加粗）
- **时间** - 显示开始-结束时间
- **时长** - 显示分钟数
- **状态标签** - 显示"已完成"（绿色背景）

**打卡事件：**
- 显示在全天事件区域
- 橙色星星图标 ⭐
- "📍 每日打卡"文字

#### 交互行为

- **点击返回按钮** → 返回紧凑月视图
- **左右滑动迷你周视图** → 切换不同日期
- **纵向滚动时间轴** → 查看全天24小时
- **点击事件卡片** → 查看事件详情（TODO）

---

## 🎨 视觉设计规范

### 颜色方案

| 元素 | 颜色 | 说明 |
|-----|-----|------|
| 今日标记 | `Colors.red` | 红色圆圈背景 |
| 月份标题 | `Colors.red` | 大号红色文字 |
| 事件圆点 | `Colors.orange` | 橙色圆点 |
| 全天事件背景 | `#FFF4E6` | 浅橙色 |
| 番茄钟事件 | `AppColors.pomodoro` | 红色系 |
| 打卡事件 | `AppColors.checkIn` | 绿色系 |
| 周末日期 | `Colors.grey[400]` | 浅灰色 |

### 字体大小

| 元素 | 字号 | 字重 |
|-----|-----|-----|
| 月份标题 | 24px | Bold |
| 日期数字 | 16px | Normal / Bold（今天） |
| 星期标题 | 12px | Medium |
| 日期标题 | 18px | Bold |
| 事件标题 | 15px | SemiBold |
| 事件时间 | 13px | Normal |
| 事件时长 | 12px | Normal |

### 间距规范

- 月份标题上边距：24px
- 月份标题下边距：12px
- 日历网格内边距：8px
- 日期单元格边距：2px
- 事件卡片边距：8px（下）
- 事件卡片内边距：12px

---

## 🎬 动画效果

### 视图切换动画

```dart
AnimatedSwitcher(
  duration: Duration(milliseconds: 300),
  switchInCurve: Curves.easeInOut,
  switchOutCurve: Curves.easeInOut,
  transitionBuilder: FadeTransition + SlideTransition,
)
```

**效果：**
- 淡入淡出（FadeTransition）
- 轻微滑动（SlideTransition，x=0.05）
- 过渡时长：300ms
- 缓动曲线：easeInOut

---

## 📊 数据加载策略

### 数据范围

```dart
// 加载前后3个月的数据
startDate = DateTime(year, month - 3, 1)
endDate = DateTime(year, month + 4, 0)
```

**优势：**
- 支持流畅的多月份滚动
- 减少频繁的数据加载
- 提升用户体验

### 数据类型

1. **打卡记录** (`List<CheckIn>`)
   - 从 `CheckInRepository` 加载
   - 按日期范围查询

2. **番茄钟记录** (`List<PomodoroRecord>`)
   - 从 `PomodoroRepository` 加载
   - 按日期范围查询
   - 统计每日工作模式的完成数量

3. **统计数据** (`Map<String, int>`)
   - Key: 日期字符串（YYYY-MM-DD）
   - Value: 番茄钟数量

### 加载超时

```dart
.timeout(const Duration(seconds: 5))
```

所有数据加载都有5秒超时保护，防止界面卡死。

---

## 🏗️ 技术实现

### 核心代码结构

```dart
class CalendarView extends StatefulWidget {
  // 状态管理
  CalendarViewMode _viewMode;           // 视图模式
  CalendarDisplayState _displayState;   // 展开/折叠状态
  DateTime _selectedMonth;              // 当前月份
  DateTime? _selectedDate;              // 选中的日期
  
  // 数据
  List<CheckIn> _checkIns;
  List<PomodoroRecord> _pomodoroRecords;
  Map<String, int> _pomodoroCountByDate;
  
  // 方法
  _buildTopBar()                    // 顶部导航栏
  _buildCompactView()               // 紧凑视图入口
  _buildCompactMonthView()          // 紧凑月视图
  _buildDayDetailView()             // 日详情视图
  _buildMiniWeekView()              // 迷你周视图
  _buildTimelineView()              // 24小时时间轴
}
```

### 状态枚举

```dart
/// 视图模式
enum CalendarViewMode {
  compact,    // 紧凑
  stacked,    // 叠放
  detailed,   // 详细信息
  list,       // 列表
}

/// 展开状态（仅用于紧凑模式）
enum CalendarDisplayState {
  collapsed,  // 折叠：月历视图
  expanded,   // 展开：日详情视图
}
```

---

## 📝 待优化项

### 短期优化（P1）

- [ ] 接入真实的农历计算
- [ ] 添加节气/节日显示
- [ ] 优化数据缓存策略
- [ ] 添加"今天"快速跳转按钮
- [ ] 优化滚动性能（虚拟滚动）

### 中期优化（P2）

- [ ] 支持点击事件卡片查看详情
- [ ] 添加快速创建事件功能（+ 按钮）
- [ ] 添加搜索功能（🔍 按钮）
- [ ] 支持年份选择器
- [ ] 添加加载动画优化

### 长期规划（P3）

- [ ] 实现第二种视图：叠放
- [ ] 实现第三种视图：详细信息
- [ ] 实现第四种视图：列表
- [ ] 支持待办事项显示
- [ ] 支持习惯追踪显示

---

## 🎯 后续三种视图方案（待讨论）

### 方案二：叠放视图（Stacked）

**预期效果：**
- 类似卡片堆叠效果
- 每张卡片显示一天的概览
- 可左右滑动切换日期
- 上下滑动查看更多卡片

**适用场景：**
- 快速浏览多天的数据
- 强调视觉层次感
- 沉浸式体验

---

### 方案三：详细信息视图（Detailed）

**预期效果：**
- 显示更丰富的统计信息
- 图表展示（柱状图、折线图）
- 连续打卡天数
- 月度/周度统计

**适用场景：**
- 数据分析
- 查看趋势
- 成就回顾

---

### 方案四：列表视图（List）

**预期效果：**
- 时间线列表形式
- 按日期分组
- 显示每日所有事件
- 类似活动日志

**适用场景：**
- 快速查找历史记录
- 详细的时间线视图
- 导出数据前预览

---

## 🐛 已知问题

暂无

---

## ✅ 测试清单

- [x] 紧凑月视图正确显示
- [x] 可以纵向滚动多个月份
- [x] 今日标记正确显示
- [x] 事件圆点正确显示
- [x] 点击日期展开详情视图
- [x] 迷你周视图正确显示
- [x] 可以切换不同日期
- [x] 24小时时间轴正确显示
- [x] 番茄钟事件正确显示在时间轴上
- [x] 打卡事件显示在全天区域
- [x] 返回按钮正常工作
- [x] 视图切换动画流畅
- [x] 视图模式切换菜单正常工作
- [x] 未实现的视图显示占位符
- [x] 数据加载超时保护正常
- [x] 无 Linter 错误

---

## 📚 相关文档

- [CALENDAR_SYNC.md](./CALENDAR_SYNC.md) - 系统日历同步功能
- [DESIGN.md](./DESIGN.md) - 整体设计规范
- [CHANGELOG.md](./CHANGELOG.md) - 更新日志

---

**最后更新**: 2025-11-09  
**实现者**: AI Assistant  
**审核状态**: ⏳ 待用户审核


